<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Alley Cat 訂位</title>
<style>
  body {
    background-color: #000;
    color: #fff;
    font-family: 'Arial', sans-serif;
    margin: 0;
    padding: 0;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    justify-content: space-between;
    align-items: center;
  }
  header img, footer img {
    width: 100%;
    max-height: 180px;
    object-fit: cover;
  }
  .container {
    background: #111;
    border-radius: 16px;
    padding: 20px;
    width: 90%;
    max-width: 450px;
    box-shadow: 0 0 10px rgba(255,255,255,0.1);
    text-align: center;
    position: relative;
  }
  #logo {
    max-width: 120px;
    margin-bottom: 10px;
  }
  #dateSlider { display: flex; gap:6px; overflow-x:auto; padding:6px 0; }
  .slider-item {
    flex: 0 0 auto;
    padding:6px 12px;
    border-radius:6px;
    background:#222;
    cursor:pointer;
    white-space:nowrap;
    transition: all 0.3s;
    border:1px solid #555;
    text-align:center;
    font-size:14px;
  }
  .slider-item.selected { background:#ff8800; color:#000; border-color:#ff8800; }
  .slider-item span { display:block; }
  #timeContainer { display:flex; flex-wrap:wrap; gap:4px; justify-content:center; margin:12px 0; }
  .time-btn { width:60px; text-align:center; padding:4px 8px; border-radius:6px; border:1px solid #555; background:#222; color:#fff; font-size:14px; cursor:pointer; white-space:nowrap; }
  .time-btn.selected { background:#ff8800; color:#000; border-color:#ff8800; }
  input, textarea { width:100%; margin:6px 0; padding:8px; border-radius:4px; border:1px solid #333; background:#222; color:#fff; }
  button { margin-top:12px; padding:10px; width:100%; border:none; border-radius:6px; background-color:#ff8800; color:#fff; font-size:16px; cursor:pointer; transition: opacity 0.3s; }
  button.loading { pointer-events:none; opacity:0.7; position:relative; }
  button.loading::after {
    content:"";
    position:absolute;
    right:50%;
    top:50%;
    width:20px;
    height:20px;
    border:2px solid #fff;
    border-top:2px solid transparent;
    border-radius:50%;
    transform:translate(50%, -50%);
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { 100% { transform:translate(50%, -50%) rotate(360deg); } }
</style>
</head>
<body>

<header>
  <img src="https://github.com/alleycatpty/Reservations/blob/main/%E9%9D%92%E6%B5%B7%E4%B8%8A.png?raw=true" alt="Top Image">
</header>

<div class="container">
  <img id="logo" src="https://github.com/alleycatpty/Reservations/blob/main/alley%20cat%20logo%20white.png?raw=true" alt="Logo">
  <h1 id="title"></h1>

  <!-- 日期滑動區 -->
  <div id="dateSlider"></div>
  <!-- 時間按鈕區 -->
  <div id="timeContainer"></div>

  <!-- 表單 -->
  <form id="reservationForm" method="POST" action="https://script.google.com/macros/s/AKfycbySL1SJdGrwNZ7uR88YXG6nK-Bt0ssHa9S_L2C5b0xL5DRD9SgJ20kFTI6kDllx1eNqew/exec" target="hidden_iframe">
    <input type="hidden" name="action" value="submitReservation">
    <input type="hidden" id="dateInput" name="date">
    <input type="hidden" id="timeInput" name="time">
    <input type="hidden" id="langInput" name="lang">

    <input id="nameInput" name="name" placeholder="姓名" required>
    <input id="phoneInput" name="phone" placeholder="電話" required>
    <input id="emailInput" name="email" placeholder="Email" required>
    <input id="peopleInput" name="people" placeholder="人數" required>
    <textarea id="noteInput" name="note" placeholder="備註 (可不填)"></textarea>

    <button type="submit" id="submitBtn">送出</button>
    <div class="message" id="message"></div>
  </form>

  <iframe name="hidden_iframe" style="display:none;"></iframe>
</div>

<footer>
  <img src="https://github.com/alleycatpty/Reservations/blob/main/%E9%9D%92%E6%B5%B7%E4%B8%8B.png?raw=true" alt="Bottom Image">
</footer>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbywwsqiPYJC7PBdgkU0iSz8TNFfLT43jZW3fwmdIdphX_CQclFrqSVeZ65M7NE_-VEYow/exec";

const lang = navigator.language.slice(0,2);
const i18n = {
  zh:{ title:"Alley Cat 訂位", noDates:"無可預訂日期", noTimes:"無可預訂時間", required:"請填寫所有必填欄位！", success:"感謝您的訂位！", name:"姓名", phone:"電話", email:"Email", people:"人數", note:"備註 (可不填)", submit:"送出" },
  en:{ title:"Alley Cat Reservation", noDates:"No available dates", noTimes:"No available times", required:"Please fill in all required fields!", success:"Thank you for your booking!", name:"Name", phone:"Phone", email:"Email", people:"People", note:"Note (optional)", submit:"Submit" }
};
const L = i18n[lang] || i18n.en;

// 更新文字
document.getElementById('title').textContent = L.title;
document.getElementById('nameInput').placeholder = L.name;
document.getElementById('phoneInput').placeholder = L.phone;
document.getElementById('emailInput').placeholder = L.email;
document.getElementById('peopleInput').placeholder = L.people;
document.getElementById('noteInput').placeholder = L.note;
document.getElementById('submitBtn').textContent = L.submit;

let selectedDate = "";
let selectedTime = "";
let dateData = [];

// 日期格式化
function formatDate(dateStr){
  const d = new Date(dateStr);
  const optionsDay = { month:'short', day:'numeric'};
  const optionsWeek = { weekday:'short'};
  return { day:d.toLocaleDateString('en-US', optionsDay), week:d.toLocaleDateString('en-US', optionsWeek) };
}

function createTimeButtons(times){
  const container = document.getElementById('timeContainer');
  container.innerHTML = '';
  if(!times || times.length===0){
    container.innerHTML = `<span style="color:tomato">${L.noTimes}</span>`;
    return;
  }
  times.forEach(t=>{
    const btn = document.createElement('button');
    btn.type = "button";
    btn.className = "time-btn";
    btn.textContent = t;
    btn.addEventListener('click', ()=>{
      container.querySelectorAll('button').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      selectedTime = t;
    });
    container.appendChild(btn);
  });
}

function createDateSlider(dates){
  const slider = document.getElementById('dateSlider');
  slider.innerHTML = '';
  if(!dates || dates.length===0){
    slider.innerHTML = `<span style="color:tomato">${L.noDates}</span>`;
    return;
  }
  dates.forEach((item,index)=>{
    const div = document.createElement('div');
    div.className='slider-item';
    const f = formatDate(item.date);
    div.innerHTML = `<span>${f.day}</span><span>${f.week}</span>`;
    div.addEventListener('click', ()=>{
      slider.querySelectorAll('.slider-item').forEach(d=>d.classList.remove('selected'));
      div.classList.add('selected');
      selectedDate = item.date;
      createTimeButtons(item.time);
    });
    slider.appendChild(div);
    if(index===0){
      div.classList.add('selected');
      selectedDate = item.date;
      createTimeButtons(item.time);
    }
  });
}

async function fetchDates(){
  try{
    const res = await fetch(`${SCRIPT_URL}?action=getAvailableTimes`);
    const data = await res.json();
    dateData = Array.isArray(data)?data:[];
    createDateSlider(dateData);
  }catch(err){
    console.error("❌ 取得日期資料失敗:", err);
  }
}
document.addEventListener('DOMContentLoaded', fetchDates);

document.getElementById('reservationForm').addEventListener('submit', function (e) {
  const msg = document.getElementById('message');
  msg.textContent = "";

  if (!selectedDate || !selectedTime) {
    msg.textContent = L.required;
    msg.style.color = "tomato";
    e.preventDefault();
    return;
  }

  document.getElementById('dateInput').value = selectedDate;
  document.getElementById('timeInput').value = selectedTime;
  document.getElementById('langInput').value = lang;

  msg.textContent = "Submitting...";
  msg.style.color = "lightblue";

  const iframe = document.querySelector('iframe[name="hidden_iframe"]');
  iframe.onload = () => {
    msg.textContent = L.success;
    msg.style.color = "lightgreen";
  };
});
</script>
</body>
</html>
